<?xml version="1.0" encoding="UTF-8"?>
<p>Virus genealogies conditional on a transmission history are simulated by generating random coalescence times for each person in the tree. Random coalescence times are generated from the inverse cumulative density function (derivation in [
 <xref rid="pcbi.1005316.ref021" ref-type="bibr">21</xref>]) 
 <disp-formula id="pcbi.1005316.e003">
  <alternatives>
   <graphic xlink:href="pcbi.1005316.e003.jpg" id="pcbi.1005316.e003g" mimetype="image" position="anchor" orientation="portrait" xmlns:xlink="http://www.w3.org/1999/xlink"/>
   <math id="M3">
    <mrow>
     <msup>
      <mi>F</mi>
      <mrow>
       <mo>−</mo>
       <mn>1</mn>
      </mrow>
     </msup>
     <mrow>
      <mo>(</mo>
      <mi>u</mi>
      <mo>)</mo>
     </mrow>
     <mo>=</mo>
     <mn>1</mn>
     <mo>−</mo>
     <msup>
      <mrow>
       <mrow>
        <mo>(</mo>
        <mrow>
         <mn>1</mn>
         <mo>−</mo>
         <mi>u</mi>
        </mrow>
        <mo>)</mo>
       </mrow>
      </mrow>
      <mrow>
       <mfrac>
        <mi>b</mi>
        <mrow>
         <mrow>
          <mo>(</mo>
          <mrow>
           <mtable>
            <mtr>
             <mtd>
              <mi>k</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mn>2</mn>
             </mtd>
            </mtr>
           </mtable>
          </mrow>
          <mo>)</mo>
         </mrow>
        </mrow>
       </mfrac>
      </mrow>
     </msup>
     <mrow>
      <mo>(</mo>
      <mrow>
       <mi>a</mi>
       <mo>+</mo>
       <mi>b</mi>
       <mi>t</mi>
      </mrow>
      <mo>)</mo>
     </mrow>
     <msup>
      <mi>b</mi>
      <mrow>
       <mo>−</mo>
       <mn>1</mn>
      </mrow>
     </msup>
    </mrow>
   </math>
  </alternatives>
 </disp-formula> where 
 <italic>u</italic> is a uniform random variate on (0, 1), 
 <italic>t</italic> is the current time along the forward time axis, 
 <italic>b</italic> is the linear rate of change (
 <italic>β</italic>
 <sub>1</sub> or 
 <italic>β</italic>
 <sub>2</sub> depending on the phase), 
 <italic>a</italic> is the starting population size (1 in the first phase and 
 <italic>β</italic>
 <sub>1</sub>
 <italic>t</italic>
 <sub>
  <italic>x</italic>
 </sub> in the second phase) and 
 <italic>k</italic> is the number of extant sampled lineages in a given host. For each host we draw random values of 
 <italic>t</italic>
 <sub>
  <italic>x</italic>
 </sub> and 
 <italic>β</italic>
 <sub>2</sub> from the prior distributions. Starting at the last transmission or sampling event, we first move to the next event along the reverse time axis, which is either a transmission event, a rate change, or the time at which the current host was infected. If the event is a transmission event, then 
 <italic>k</italic> is incremented and a random coalescence time is generated. If that time occurs before (along the reverse time axis) the next event, then two random extant lineages in the sample are selected to coalesce; or if not, then time is moved to the time of the next event. At 
 <italic>t</italic>
 <sub>
  <italic>x</italic>
 </sub>, when the rate changes, the parameters of the inverse cumulative density function are changed to correspond to the first model-phase and the process continues until the transmission time of the current host is reached. In the rare instance where more than one sampled lineage exists at the time of infection, the existing lineages are randomly coalesced with zero length branches. Finally, each individual sub-tree is joined into a single viral genealogy according to the transmission history.
</p>
